<?php
	$this->headScript()->appendFile($this->httpScheme() . '://maps.googleapis.com/maps/api/js?sensor=false');

	$nodes = array();
	foreach ($this->nodes as $node) {
		$nodes[] = $node->toArray();
	}
	$this->headScript()->captureStart();
?>
	var nodes = <?php echo Zend_Json::encode($nodes);?>;
	var map;
	var infowindow;

	$(document).ready(function(){
		$('#nodemap').height(450);

		var latlng = new google.maps.LatLng(<?php echo $this->systemSettings['node_map_center_lat']->getValue(); ?>,
										    <?php echo $this->systemSettings['node_map_center_lng']->getValue(); ?>);
    	var myOptions = {
      		zoom: <?php echo (int) $this->systemSettings['node_map_zoom']->getValue(); ?>,
      		center: latlng,
      		mapTypeId: google.maps.MapTypeId.ROADMAP
    	};

    	map = new google.maps.Map(document.getElementById("nodemap"),
        							  myOptions);

		infowindow = new google.maps.InfoWindow();

		$.each(nodes, function(idx, data) {
			var marker = new google.maps.Marker({
		        position: new google.maps.LatLng(data.location.latitude, data.location.longitude),
		        title: data.name,
		        draggable: false
		    });

			marker.setMap(map);

		    google.maps.event.addListener(marker, 'click', function(event) {
		    	var onlinemsg = '';

		    	var date = new Date();

		    	date.setTime(data.online_status_changed);

		    	if (data.online_status > 0) {
		    		onlinemsg = 'Online since: ' + date; // .getDate() + '/' + date.getMonth() + '/' + date.getFullYear() + ' ' + date.get;
		    	} else {
		    		onlinemsg = 'Offline since: ' + date;
		    	}

				infowindow.setContent('<h5>' + marker.getTitle() +'</h5>'+
									  '<div>MAC: ' + data.mac + '</div>' +
									  '<div>Address: ' + data.location.address + ', ' + data.location.city +', ' + data.location.country + '</div>' +
									  '<div>' + onlinemsg + '</div>');
				infowindow.open(map, marker);
		    });
		});
	});

<?php
	$this->headScript()->captureEnd();
?>

<div id="nodemap"></div>